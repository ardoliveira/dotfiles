#!/bin/bash

# Collate all files, in ~/.bash.d, into a single file for easy sourcing by
# ~/.bashrc.
#
# Run this script for any changes in ~/.bash.d to be included,
# followed by a source of profile.env, or open a new shell.

CUSTOMENV=$(MyPersonalConfigs -c -f profile.env) || exit 1

QUIET=
SHOWCONFIG=
while getopts "qs" OPTS; do
	case "$OPTS" in
		q)  QUIET=1
			;;
		s)  echo "$CUSTOMENV"
			exit
			;;
	esac
done

if [ -z "$QUIET" ]; then
	echo "Updating profile.env..."
fi
#
# Use custom startup scripts in ~/.bash.d
#
cat >"$CUSTOMENV" <<_EOF_
# THIS FILE IS AUTOMATICALLY GENERATED BY $0.
# DO NOT EDIT THIS FILE. CHANGES TO STARTUP PROFILES
# GO INTO ~/.bash.d NOT $CUSTOMENV

# File Generated on $(date)

_EOF_

if [ -d ~/.bash.d/hosts/$(hostname) ]; then
	find -L ~/.bash.d/hosts/$(hostname) -type f -print0 |\
		sort -z |\
		while read -d $'\0' file
	do
		echo -ne "\n#\n# FILE: $file\n#\n\n"
		cat "$file"
	done >> "$CUSTOMENV"
elif [ -d ~/.bash.d/hosts/generic ]; then
	# Use ~/.bash.d/hosts/generic if $(hostname) directory doesn't exist.
	find -L ~/.bash.d/hosts/generic -type f -print0 |\
		sort -z |\
		while read -d $'\0' file
	do
		echo -ne "\n#\n# FILE: $file\n#\n\n"
		cat "$file"
	done >> "$CUSTOMENV"
fi

if [ -z "$QUIET" ]; then
	echo "Done."
	echo
	echo "For changes to take effect immediately, run:"
	echo
	echo "source $CUSTOMENV"
fi

